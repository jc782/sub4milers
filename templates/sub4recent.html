{% extends 'base.html' %}
{% load static %}

{% block title %}Most Recent Sub-4 Milers{% endblock %}

{% block content %}

<style>
  .search-wrap {
    position: relative;
    margin-bottom: 28px;
    max-width: 480px;
  }
  .search-wrap svg {
    position: absolute;
    left: 14px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--subtle);
    pointer-events: none;
    width: 16px;
    height: 16px;
  }
  .search-input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Mono', monospace;
    font-size: .82rem;
    padding: 12px 16px 12px 42px;
    border-radius: 6px;
    outline: none;
    transition: border-color .2s, box-shadow .2s;
    letter-spacing: .04em;
  }
  .search-input::placeholder { color: var(--muted); }
  .search-input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(200,241,53,.08);
  }

  .table-meta {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
    flex-wrap: wrap;
    gap: 8px;
  }
  .view-label {
    font-family: 'DM Mono', monospace;
    font-size: .68rem;
    letter-spacing: .18em;
    text-transform: uppercase;
    color: var(--subtle);
  }
  .row-count {
    font-family: 'DM Mono', monospace;
    font-size: .68rem;
    color: var(--muted);
  }
  #row-count-num { color: var(--accent); }

  .date-unknown {
    color: var(--muted);
    font-style: italic;
    font-size: .78rem;
  }

  .table-wrap {
    overflow-x: auto;
    border: 1px solid var(--border);
    border-radius: 8px;
  }

  table#list {
    width: 100%;
    border-collapse: collapse;
    font-size: 1rem;
  }
  table#list thead tr {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
  }
  table#list thead th {
    font-family: 'DM Mono', monospace;
    font-size: .65rem;
    letter-spacing: .18em;
    text-transform: uppercase;
    color: var(--subtle);
    font-weight: 400;
    padding: 14px 16px;
    text-align: left;
    white-space: nowrap;
  }
  table#list thead th:first-child { width: 56px; text-align: center; }

  table#list tbody tr {
    border-bottom: 1px solid rgba(30,30,46,.7);
    transition: background .15s;
    animation: fadeUp .3s ease both;
  }
  table#list tbody tr:nth-child(1)  { animation-delay: .04s; }
  table#list tbody tr:nth-child(2)  { animation-delay: .07s; }
  table#list tbody tr:nth-child(3)  { animation-delay: .10s; }
  table#list tbody tr:nth-child(4)  { animation-delay: .13s; }
  table#list tbody tr:nth-child(5)  { animation-delay: .16s; }
  table#list tbody tr:nth-child(n+6){ animation-delay: .19s; }
  table#list tbody tr:last-child { border-bottom: none; }
  table#list tbody tr:hover { background: rgba(200,241,53,.035); }
  table#list tbody tr:nth-child(even) { background: rgba(255,255,255,.012); }
  table#list tbody tr:nth-child(even):hover { background: rgba(200,241,53,.04); }
  table#list tbody td { padding: 13px 16px; vertical-align: middle; }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(12px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .col-rank {
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: .72rem;
    color: var(--muted);
    width: 56px;
  }
  .col-name    { font-weight: 500; color: var(--bright); letter-spacing: .01em; }
  .col-time    { font-family: 'Bebas Neue', sans-serif; font-size: 1.3rem; letter-spacing: .06em; color: var(--accent); }
  .col-date    { font-family: 'DM Mono', monospace; font-size: .82rem; color: var(--subtle); white-space: nowrap; }
  .col-country { font-size: 1.2rem; letter-spacing: .02em; }

  @media (max-width: 768px) { .hide-mobile { display: none; } }
</style>

<div class="table-meta">
  <span class="view-label">üïê Ranked by Most Recent Sub-4</span>
  <span class="row-count">Showing <span id="row-count-num">‚Äî</span> athletes</span>
</div>

<div class="search-wrap">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
    <circle cx="11" cy="11" r="8"/><path stroke-linecap="round" d="m21 21-4.35-4.35"/>
  </svg>
  <input type="text" class="search-input" id="tableSearch" placeholder="Search athletes, countries‚Ä¶" autocomplete="off">
</div>

<div class="table-wrap">
  <table id="list">
    <thead>
      <tr>
        <th>#</th>
        <th>Athlete</th>
        <th>First Sub-4 Time</th>
        <th class="hide-mobile">Date</th>
        <th class="hide-mobile">Country</th>
      </tr>
    </thead>
    <tbody>
      {% for sub4 in athletes %}
      <tr>
        <td class="col-rank">{{ forloop.counter }}</td>
        <td class="col-name">{{ sub4.name | title }}</td>
        <td class="col-time">{{ sub4.firstTime | time:"i:s" }}:{{ sub4.firstTime|time:'u'|add:'0'|stringformat:'06i'|slice:':2' }}</td>
        <td class="col-date hide-mobile">{% if sub4.firstDate %}{{ sub4.firstDate }}{% else %}<span class="date-unknown">unknown</span>{% endif %}</td>
        <td class="col-country hide-mobile" data-country="{{ sub4.countries | title }}"></td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  const FLAGS = {
    "Alg":"üá©üáø","Ang":"üá¶üá¥","Ben":"üáßüáØ","Bot":"üáßüáº","Bdi":"üáßüáÆ","Cmr":"üá®üá≤","Cpv":"üá®üáª","Caf":"üá®üá´","Cha":"üáπüá©","Com":"üá∞üá≤",
    "Cgo":"üá®üá¨","Cod":"üá®üá©","Dji":"üá©üáØ","Egy":"üá™üá¨","Gnq":"üá¨üá∂","Eri":"üá™üá∑","Swz":"üá∏üáø","Eth":"üá™üáπ","Gab":"üá¨üá¶","Gam":"üá¨üá≤",
    "Gha":"üá¨üá≠","Gui":"üá¨üá≥","Gnb":"üá¨üáº","Civ":"üá®üáÆ","Ken":"üá∞üá™","Les":"üá±üá∏","Lbr":"üá±üá∑","Lba":"üá±üáæ","Mad":"üá≤üá¨","Maw":"üá≤üáº",
    "Mli":"üá≤üá±","Mtn":"üá≤üá∑","Mri":"üá≤üá∫","Mar":"üá≤üá¶","Moz":"üá≤üáø","Nam":"üá≥üá¶","Nig":"üá≥üá™","Ngr":"üá≥üá¨","Reu":"üá∑üá™","Rwa":"üá∑üáº",
    "Stp":"üá∏üáπ","Sen":"üá∏üá≥","Sey":"üá∏üá®","Sle":"üá∏üá±","Som":"üá∏üá¥","Rsa":"üáøüá¶","Sud":"üá∏üá©","Ssd":"üá∏üá∏","Tan":"üáπüáø","Tog":"üáπüá¨",
    "Tun":"üáπüá≥","Uga":"üá∫üá¨","Zam":"üáøüá≤","Zim":"üáøüáº",
    "Ant":"üá¶üá¨","Arg":"üá¶üá∑","Arb":"üá¶üáº","Bah":"üáßüá∏","Bar":"üáßüáß","Blz":"üáßüáø","Ber":"üáßüá≤","Bol":"üáßüá¥","Bra":"üáßüá∑","Ivb":"üáªüá¨",
    "Can":"üá®üá¶","Cay":"üá∞üáæ","Chi":"üá®üá±","Col":"üá®üá¥","Crc":"üá®üá∑","Cub":"üá®üá∫","Dom":"üá©üá¥","Ecu":"üá™üá®","Slv":"üá∏üáª","Grd":"üá¨üá©",
    "Gtm":"üá¨üáπ","Gua":"üá¨üáπ","Guy":"üá¨üáæ","Hai":"üá≠üáπ","Hon":"üá≠üá≥","Jam":"üáØüá≤","Mex":"üá≤üáΩ","Nca":"üá≥üáÆ","Pan":"üáµüá¶","Par":"üáµüáæ",
    "Per":"üáµüá™","Pto":"üáµüá∑","Skn":"üá∞üá≥","Lca":"üá±üá®","Vin":"üáªüá®","Sur":"üá∏üá∑","Tto":"üáπüáπ","Uru":"üá∫üáæ","Usa":"üá∫üá∏","Ven":"üáªüá™","Isv":"üáªüáÆ",
    "Afg":"üá¶üá´","Brn":"üáßüá≠","Ban":"üáßüá©","Btn":"üáßüáπ","Bru":"üáßüá≥","Cam":"üá∞üá≠","Chn":"üá®üá≥","Hkg":"üá≠üá∞","Ind":"üáÆüá≥","Ina":"üáÆüá©",
    "Iri":"üáÆüá∑","Irq":"üáÆüá∂","Isr":"üáÆüá±","Jpn":"üáØüáµ","Jor":"üáØüá¥","Kaz":"üá∞üáø","Prk":"üá∞üáµ","Kor":"üá∞üá∑","Kuw":"üá∞üáº","Kgz":"üá∞üá¨",
    "Lao":"üá±üá¶","Lbn":"üá±üáß","Mac":"üá≤üá¥","Mas":"üá≤üáæ","Mdv":"üá≤üáª","Mgl":"üá≤üá≥","Mya":"üá≤üá≤","Nep":"üá≥üáµ","Oma":"üá¥üá≤","Pak":"üáµüá∞",
    "Phi":"üáµüá≠","Qat":"üá∂üá¶","Ksa":"üá∏üá¶","Sin":"üá∏üá¨","Sri":"üá±üá∞","Syr":"üá∏üáæ","Tpe":"üáπüáº","Tjk":"üáπüáØ","Tha":"üáπüá≠","Tkm":"üáπüá≤",
    "Uae":"üá¶üá™","Uzb":"üá∫üáø","Vie":"üáªüá≥","Yem":"üáæüá™",
    "Alb":"üá¶üá±","And":"üá¶üá©","Arm":"üá¶üá≤","Aut":"üá¶üáπ","Aze":"üá¶üáø","Blr":"üáßüáæ","Bel":"üáßüá™","Bih":"üáßüá¶","Bul":"üáßüá¨","Cro":"üá≠üá∑",
    "Cyp":"üá®üáæ","Cze":"üá®üáø","Den":"üá©üá∞","Est":"üá™üá™","Fin":"üá´üáÆ","Fra":"üá´üá∑","Geo":"üá¨üá™","Ger":"üá©üá™","Gbr":"üá¨üáß","Gre":"üá¨üá∑",
    "Hun":"üá≠üá∫","Isl":"üáÆüá∏","Irl":"üáÆüá™","Ita":"üáÆüáπ","Kos":"üáΩüá∞","Lat":"üá±üáª","Lie":"üá±üáÆ","Ltu":"üá±üáπ","Lux":"üá±üá∫","Mkd":"üá≤üá∞",
    "Mlt":"üá≤üáπ","Mda":"üá≤üá©","Mon":"üá≤üá®","Mne":"üá≤üá™","Ned":"üá≥üá±","Nor":"üá≥üá¥","Pol":"üáµüá±","Por":"üáµüáπ","Rom":"üá∑üá¥","Rou":"üá∑üá¥",
    "Rus":"üá∑üá∫","Smr":"üá∏üá≤","Srb":"üá∑üá∏","Svk":"üá∏üá∞","Slo":"üá∏üáÆ","Esp":"üá™üá∏","Swe":"üá∏üá™","Sui":"üá®üá≠","Tur":"üáπüá∑","Ukr":"üá∫üá¶",
    "Aus":"üá¶üá∫","Nzl":"üá≥üáø","Png":"üáµüá¨","Fij":"üá´üáØ","Sam":"üáºüá∏","Sol":"üá∏üáß","Van":"üáªüá∫",
    "Frg":"üá©üá™","Gdr":"üá©üá™","Urs":"üá∑üá∫","Yug":"üá∑üá∏","Tch":"üá®üáø","Ana":"üá∑üá∏","Scg":"üá∑üá∏","Roc":"üá∑üá∫",
  };

  function getFlag(raw) {
    if (!raw || raw.trim() === '' || raw.trim().toLowerCase() === 'nan') return 'üè≥Ô∏è';
    return raw.split(/[\/,]/).map(p => FLAGS[p.trim()] || 'üè≥Ô∏è').join(' ');
  }

  document.querySelectorAll('.col-country[data-country]').forEach(td => {
    td.innerHTML = getFlag(td.dataset.country);
  });

  const tbody    = document.querySelector('#list tbody');
  const countEl  = document.getElementById('row-count-num');
  const heroEl   = document.getElementById('total-count');
  const total    = tbody.querySelectorAll('tr').length;
  countEl.textContent = total.toLocaleString();
  if (heroEl) heroEl.textContent = total.toLocaleString();

  document.getElementById('tableSearch').addEventListener('input', function () {
    const q = this.value.toLowerCase();
    let visible = 0;
    tbody.querySelectorAll('tr').forEach(row => {
      const match = row.textContent.toLowerCase().includes(q);
      row.style.display = match ? '' : 'none';
      if (match) visible++;
    });
    countEl.textContent = visible.toLocaleString();
  });
</script>

{% endblock %}